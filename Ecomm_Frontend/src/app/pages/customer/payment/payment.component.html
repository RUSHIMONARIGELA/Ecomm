<div class="container mt-4">
  <div class="card shadow-sm rounded-3">
    <div class="card-header bg-primary text-white py-3">
      <h3 class="mb-0">Complete Your Payment</h3>
    </div>
    <div class="card-body p-4">
      <div *ngIf="loadingOrder" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading order...</span>
        </div>
        <p class="mt-2">Loading order details for payment...</p>
      </div>

      <div
        *ngIf="orderError"
        class="alert alert-danger alert-dismissible fade show"
        role="alert"
      >
        {{ orderError }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
          (click)="orderError = null"
        ></button>
      </div>

      <div *ngIf="!loadingOrder && !orderError && order">
        <h4 class="mb-3">Order Summary</h4>
        <ul class="list-group mb-4">
          <li
            class="list-group-item d-flex justify-content-between align-items-center"
            *ngFor="let item of order.orderItems"
          >
            <div>
              <span class="fw-bold">{{ item.productDetails.name }}</span>
              <span class="text-muted ms-2">x {{ item.quantity }}</span>
            </div>
            <span>Rs.{{ item.quantity * item.price | number : "1.2-2" }}</span>
          </li>

          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>Subtotal:</span>
            <span>Rs.{{ getOrderSubtotal() | number : "1.2-2" }}</span>
          </li>

          <li
            *ngIf="order.discountAmount && order.discountAmount > 0"
            class="list-group-item d-flex justify-content-between align-items-center text-success"
          >
            <span>Discount ({{ order.couponCode }}):</span>
            <span>-Rs.{{ order.discountAmount | number : "1.2-2" }}</span>
          </li>

          <li
            class="list-group-item d-flex justify-content-between align-items-center bg-light fw-bold"
          >
            <span>Total Amount:</span>
            <span class="fs-5 text-success"
              >Rs.{{ order.totalAmount | number : "1.2-2" }}</span
            >
          </li>
        </ul>

        <h4 class="mb-3">Payment Method</h4>
        <div class="mb-4">
          <div class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="paymentMethod"
              id="razorpay"
              value="RAZORPAY"
              [(ngModel)]="selectedPaymentMethod"
            />
            <label class="form-check-label" for="razorpay">
              Razorpay (Credit Card / Debit Card / Netbanking)
            </label>
          </div>
          <!-- <div class="form-check mt-2">
            <input
              class="form-check-input"
              type="radio"
              name="paymentMethod"
              id="upi-qr-code"
              value="UPI_QR_CODE"
              [(ngModel)]="selectedPaymentMethod"
            />
            <label class="form-check-label" for="upi-qr-code">
              Pay with UPI App (Scan QR Code)
            </label>
          </div> -->
        </div>

        <div *ngIf="selectedPaymentMethod === 'UPI_QR_CODE'">
          <div *ngIf="loadingQrCode" class="text-center my-4">
            <div class="spinner-border text-info" role="status">
              <span class="visually-hidden">Generating QR Code...</span>
            </div>
            <p class="mt-2">Generating UPI QR Code...</p>
          </div>

          <div
            *ngIf="qrCodeError"
            class="alert alert-danger alert-dismissible fade show my-4"
            role="alert"
          >
            {{ qrCodeError }}
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
              aria-label="Close"
              (click)="qrCodeError = null"
            ></button>
          </div>

          <div *ngIf="upiQRCodeUrl && !loadingQrCode" class="text-center my-4">
            <h5>Scan to Pay with any UPI App</h5>
            <img
              [src]="upiQRCodeUrl"
              alt="UPI QR Code"
              class="img-fluid border border-2 p-2 rounded"
              style="max-width: 250px; height: auto;"
            />
            <p class="mt-3 text-muted">Please refresh the page to generate a new QR code.</p>
          </div>
        </div>

        <div
          *ngIf="paymentSuccessMessage"
          class="alert alert-success alert-dismissible fade show"
          role="alert"
        >
          {{ paymentSuccessMessage }}
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="alert"
            aria-label="Close"
            (click)="paymentSuccessMessage = null"
          ></button>
        </div>
        <div
          *ngIf="paymentErrorMessage"
          class="alert alert-danger alert-dismissible fade show"
          role="alert"
        >
          {{ paymentErrorMessage }}
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="alert"
            aria-label="Close"
            (click)="paymentErrorMessage = null"
          ></button>
        </div>

        <div class="d-grid gap-2">
          <button
            class="btn btn-success btn-lg"
            (click)="processPayment()"
            [disabled]="processingPayment || loadingQrCode || !order || order.status === 'PAID'"
          >
            <span
              *ngIf="processingPayment || loadingQrCode"
              class="spinner-border spinner-border-sm me-2"
              role="status"
              aria-hidden="true"
            ></span>
            <span *ngIf="selectedPaymentMethod === 'RAZORPAY'">
              Pay Now Rs.{{ order.totalAmount | number : "1.2-2" }}
            </span>
            <span *ngIf="selectedPaymentMethod === 'UPI_QR_CODE'">
              Generate QR Code to Pay
            </span>
          </button>
        </div>
      </div>

      <div
        *ngIf="!loadingOrder && !orderError && !order"
        class="alert alert-info text-center py-4"
        role="alert"
      >
        <h4 class="alert-heading">No order found for payment.</h4>
        <p>Please ensure you have an active order to proceed with payment.</p>
        <hr />
        <a routerLink="/home/cart" class="btn btn-primary">Go to Cart</a>
      </div>
    </div>
  </div>
</div>